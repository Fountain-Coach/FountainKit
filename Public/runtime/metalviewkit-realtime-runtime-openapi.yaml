openapi: 3.1.0
info:
  title: MetalViewKit Realtime Runtime API
  version: 0.2.0
  summary: Platform-neutral realtime runtime with MIDI 2.0, audio, video, deterministic testing, and a thin hardware audio adapter (CoreAudio/ALSA/WASAPI).
  description: |
    This specification describes a local or sidecar HTTP/WebSocket API that manages a realtime runtime
    for MIDI 2.0 event processing, audio rendering, and video frame scheduling. The runtime supports
    deterministic, offline testing via a virtual clock, and live hardware streaming through a minimal
    audio backend adapter (CoreAudio on Apple platforms, ALSA on Linux, WASAPI on Windows, SDL2 or a
    headless backend for tests).

    Design principles:
      • Single monotonic master clock (ns) with switchable test/virtual mode.
      • Strict thread separation in implementations (not mandated by the API).
      • Lock-free, single-producer single-consumer messaging internally (not exposed directly).
      • Timestamp-normalized MIDI 2.0 UMP scheduling with explicit lookahead semantics.
      • Hardware I/O is handled by a small adapter and surfaced via neutral endpoints.

servers:
  - url: http://localhost:7777
    description: Local development server (process-local or container sidecar).

tags:
  - name: sessions
    description: Session lifecycle and top-level configuration for the runtime.
  - name: clock
    description: Master clock operations and deterministic test-time control.
  - name: midi
    description: MIDI 2.0 Universal MIDI Packet (UMP) endpoints and event I/O for tests.
  - name: audio
    description: Deterministic "headless" audio rendering for offline tests (no hardware).
  - name: audio-backend
    description: Thin hardware audio adapter (CoreAudio/ALSA/WASAPI/SDL2) for device enumeration and streaming.
  - name: video
    description: Deterministic video tick stepping for tests (no actual drawing is performed by the API).
  - name: test
    description: Scenario loading, scripted runs, and assertions for regression tests.
  - name: faults
    description: Fault and jitter injection to stress timing and recovery logic.
  - name: metrics
    description: Aggregated counters, queue depths, and latency percentiles.
  - name: tracing
    description: Structured event tracing (pull dump or live WebSocket stream).

paths:
  /v1/sessions:
    post:
      tags: [sessions]
      summary: Create a runtime session
      description: |
        Creates a new session with the provided configuration. A session encapsulates sample rate,
        audio block size, refresh rate, MIDI group count, lookahead window, and tracing buffer size.
        Implementations may allow only a single active session; if multiple are allowed, selection is
        implementation-defined. The session begins in a "running" state with the master clock active.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SessionCreate' }
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Session' }

  /v1/sessions/{id}:
    get:
      tags: [sessions]
      summary: Get session details
      description: Returns the session configuration and current state for the specified session ID.
      parameters: [ { $ref: '#/components/parameters/SessionId' } ]
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Session' } } } }
    delete:
      tags: [sessions]
      summary: Stop and delete session
      description: Stops background processing and releases resources for the specified session ID.
      parameters: [ { $ref: '#/components/parameters/SessionId' } ]
      responses: { '204': { description: Session deleted } }

  /v1/clock:
    get:
      tags: [clock]
      summary: Read current master clock
      description: |
        Returns the current time of the monotonic master clock in nanoseconds and indicates whether the
        clock is in system or deterministic test mode.
      responses:
        '200':
          description: Clock value returned
          content: { application/json: { schema: { $ref: '#/components/schemas/ClockNow' } } }

  /v1/clock/test/enable:
    post:
      tags: [clock, test]
      summary: Enable virtual (deterministic) test clock
      description: |
        Switches the runtime from system clock to a deterministic test clock. If a start time is
        provided, the clock is initialized to that value; otherwise it continues from the current
        system time. When enabled, time advances only via /v1/clock/test/advance.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                startNs: { $ref: '#/components/schemas/TimestampNs' }
      responses: { '204': { description: Test clock enabled } }

  /v1/clock/test/advance:
    post:
      tags: [clock, test]
      summary: Advance virtual clock deterministically
      description: |
        Advances the test clock forward by deltaNs. If `steps` is provided, the advance is split into
        equal substeps (useful for simulating multiple audio callbacks per request). Returns the new
        clock time.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [deltaNs]
              properties:
                deltaNs: { $ref: '#/components/schemas/DurationNs' }
                steps:
                  type: integer
                  minimum: 1
                  description: Number of equal substeps to break deltaNs into.
      responses:
        '200':
          description: New clock value after advance
          content: { application/json: { schema: { $ref: '#/components/schemas/ClockNow' } } }

  /v1/midi/endpoints:
    get:
      tags: [midi]
      summary: List virtual MIDI endpoints
      description: |
        Returns the set of virtual MIDI endpoints (inputs and outputs) available inside the runtime.
        Endpoints are internal constructs for routing MIDI 2.0 UMP; they are not system (CoreMIDI)
        endpoints unless the implementation chooses to bridge them.
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/MidiEndpoint' } } } } }
    post:
      tags: [midi]
      summary: Create a virtual MIDI endpoint
      description: |
        Creates an internal MIDI endpoint (input or output) with declared capabilities such as group
        count and JR timestamp support. Useful for tests and for explicit routing in custom setups.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MidiEndpointCreate' }
      responses:
        '201': { description: Endpoint created, content: { application/json: { schema: { $ref: '#/components/schemas/MidiEndpoint' } } } }

  /v1/midi/events:
    post:
      tags: [midi]
      summary: Inject MIDI 2.0 UMP events (test producer)
      description: |
        Pushes timestamped UMP events into the runtime. Timestamps are in absolute ns by default;
        when `timeDomain=relativeToNow`, each event's tNs is interpreted as delta from current clock.
        Implementations normalize all events into the master clock domain upon ingest.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MidiInBatch' }
      responses:
        '202': { description: Events accepted for scheduling }
    get:
      tags: [midi]
      summary: Read scheduled/consumed MIDI events (test consumer)
      description: |
        Returns events from the runtime for verification. This is primarily intended for tests to
        validate ordering, timing, and end-to-end delivery. Production apps usually do not poll here.
      parameters:
        - in: query
          name: sinceNs
          description: Return events with timestamps >= this value (ns).
          schema: { $ref: '#/components/schemas/TimestampNs' }
        - in: query
          name: limit
          description: Maximum number of events to return.
          schema: { type: integer, minimum: 1, maximum: 10000, default: 512 }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/MidiOutBatch' } } } }

  /v1/audio/render:
    post:
      tags: [audio, test]
      summary: Deterministically render N frames (headless)
      description: |
        Offline rendering entrypoint that fills an audio buffer without touching hardware. Intended
        for deterministic unit tests and CI. Live applications should use the hardware backend endpoints
        to start streaming instead.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AudioRenderRequest' }
      responses:
        '200':
          description: Audio PCM rendered successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AudioRenderResponse' }

  /v1/video/tick:
    post:
      tags: [video, test]
      summary: Simulate a video frame tick
      description: |
        Simulates a single video frame tick at the given time. This does not draw but allows tests to
        exercise visual scheduling and synchronization logic relative to the master clock.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                frameIndex: { type: integer, minimum: 0, description: Sequential frame number for test bookkeeping. }
                tNs: { $ref: '#/components/schemas/TimestampNs' }
      responses: { '204': { description: Tick accepted } }

  /v1/faults/model:
    post:
      tags: [faults]
      summary: Configure fault & jitter model
      description: |
        Configures probability distributions and behaviors for fault injection, including MIDI jitter,
        duplication, and drop rates; audio callback stalls and overrun cadence; and master clock drift.
        Use to stress the system and validate recovery logic.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FaultModel' }
      responses: { '204': { description: Fault model applied } }

  /v1/test/scenario:
    post:
      tags: [test]
      summary: Load a scripted test scenario
      description: |
        Loads a predefined or ad-hoc test scenario consisting of MIDI injections, time advances, and
        optional assertions. Implementations may execute immediately or stage for later execution.
      requestBody:
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TestScenario' }
      responses: { '204': { description: Scenario loaded } }

  /v1/metrics:
    get:
      tags: [metrics]
      summary: Fetch runtime metrics
      description: |
        Returns aggregated counters (e.g., underruns, drops), queue depths, and latency percentiles.
        Values reflect the current session window and may reset on new sessions.
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Metrics' } } } }

  /v1/tracing/stream:
    get:
      tags: [tracing]
      summary: Live tracing WebSocket
      description: |
        Upgrades to a WebSocket connection that emits newline-delimited JSON (NDJSON) TraceEvent
        messages. Useful for live debugging during stress runs.
      responses:
        '101': { description: Switching Protocols (WebSocket established) }

  /v1/tracing/dump:
    get:
      tags: [tracing]
      summary: Dump trace ring buffer
      description: |
        Returns the current contents of the in-memory trace ring for offline analysis. Intended for
        deterministic tests and post-mortem triage.
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/TraceEvent' } } } } }

  # ---------------- Thin Hardware Audio Adapter (CoreAudio/ALSA/WASAPI/SDL2)
  /v1/audio/backend:
    get:
      tags: [audio-backend]
      summary: Get backend status
      description: |
        Returns the active backend, stream state, device binding and negotiated format, along with
        capabilities such as low-latency support and the last error (if any).
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/AudioBackendStatus' } } } }
    patch:
      tags: [audio-backend]
      summary: Update backend policy
      description: |
        Sets non-stream policies such as preferred backend selection, rebinding behavior when routes
        or formats change, and (on iOS/tvOS) AVAudioSession configuration. Does not start/stop I/O.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AudioBackendPolicy' }
      responses: { '204': { description: Policy updated } }

  /v1/audio/devices:
    get:
      tags: [audio-backend]
      summary: Enumerate audio devices
      description: |
        Lists available audio devices for the selected backend and scope (output/input/duplex). The
        returned information includes supported sample rates, nominal block sizes, and latency hints.
      parameters:
        - in: query
          name: scope
          schema: { type: string, enum: [output, input, duplex], default: output }
          description: Device direction to query.
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: array, items: { $ref: '#/components/schemas/AudioDeviceInfo' } } } } }

  /v1/audio/devices/{id}/open:
    post:
      tags: [audio-backend]
      summary: Bind device and negotiate stream format
      description: |
        Selects the given device for streaming and attempts to negotiate the desired format. If
        `allowFormatFallback` is true, the backend may adjust sample rate, block size, or channel
        count to the nearest supported configuration.
      parameters: [ { $ref: '#/components/parameters/DeviceId' } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StreamNegotiation' }
      responses:
        '200': { description: Device bound with negotiated format, content: { application/json: { schema: { $ref: '#/components/schemas/StreamConfig' } } } }

  /v1/audio/stream/start:
    post:
      tags: [audio-backend]
      summary: Start hardware streaming
      description: |
        Starts the device I/O callback thread and begins pulling/pushing audio buffers according to
        the negotiated stream configuration.
      responses: { '204': { description: Streaming started } }

  /v1/audio/stream/stop:
    post:
      tags: [audio-backend]
      summary: Stop hardware streaming
      description: Stops the device I/O callback and retains negotiated settings for potential restart.
      responses: { '204': { description: Streaming stopped } }

  /v1/audio/stream/stats:
    get:
      tags: [audio-backend]
      summary: Read live I/O statistics
      description: |
        Returns callback counts, underruns, callback duration distribution (avg/p99), and recent timing
        information to aid performance tuning and regression detection.
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/IOStats' } } } }

  /v1/audio/backend/events:
    get:
      tags: [audio-backend, tracing]
      summary: Backend events WebSocket
      description: |
        WebSocket that emits BackendEvent messages describing route changes, device loss, format
        renegotiations, and warnings from the hardware adapter.
      responses:
        '101': { description: Switching Protocols (WebSocket established) }

components:
  parameters:
    SessionId:
      name: id
      in: path
      required: true
      description: Unique identifier of the runtime session to query or mutate.
      schema: { type: string, format: uuid }
    DeviceId:
      name: id
      in: path
      required: true
      description: Backend-specific device identifier (opaque string).
      schema: { type: string }

  schemas:
    # ---------------- Shared primitives
    TimestampNs:
      type: string
      pattern: '^[0-9]+$'
      description: Unsigned integer nanoseconds since a monotonic (implementation-defined) epoch.
      example: "1234567890123"

    DurationNs:
      type: string
      pattern: '^[0-9]+$'
      description: Unsigned integer duration in nanoseconds.
      example: "2000000"

    # ---------------- Sessions
    AudioBackend:
      type: string
      enum: [coreaudio, sdl2, alsa, wasapi, null]
      description: |
        Physical/virtual audio backend used by the runtime.
        • coreaudio — Apple HAL/RemoteIO (required for hardware I/O on macOS/iOS)
        • alsa — Linux Advanced Linux Sound Architecture
        • wasapi — Windows WASAPI
        • sdl2 — SDL2 audio abstraction
        • null — headless backend for offline tests (no device)

    SessionCreate:
      type: object
      description: Configuration used to create a session.
      properties:
        sampleRate:
          type: number
          format: float
          default: 48000
          description: Target sample rate in Hz; may be adjusted by hardware negotiation.
        audioBlockFrames:
          type: integer
          enum: [64, 96, 128, 256, 512]
          default: 128
          description: Nominal audio callback block size in frames.
        refreshRateHz:
          type: number
          format: float
          default: 60
          description: Nominal video refresh rate, used for test tick calculations.
        midiGroups:
          type: integer
          minimum: 1
          maximum: 16
          default: 4
          description: Number of MIDI 2.0 groups supported by the runtime.
        lookaheadNs:
          $ref: '#/components/schemas/DurationNs'
        traceBufferLen:
          type: integer
          default: 65536
          description: Size of the trace ring buffer in events.
        backend:
          $ref: '#/components/schemas/AudioBackend'
      required: [sampleRate, audioBlockFrames]

    Session:
      type: object
      description: Session identity, configuration, and state.
      properties:
        id: { type: string, format: uuid, description: Session identifier. }
        config: { $ref: '#/components/schemas/SessionCreate' }
        state: { type: string, enum: [running, stopped], description: Current session state. }

    # ---------------- MIDI
    MidiEndpointCreate:
      type: object
      description: Request to create a virtual MIDI endpoint inside the runtime.
      properties:
        name: { type: string, description: Human-readable endpoint name. }
        direction: { type: string, enum: [input, output], description: Endpoint direction. }
        groups: { type: integer, minimum: 1, maximum: 16, default: 1, description: Number of MIDI 2.0 groups supported. }
        jrTimestampSupport: { type: boolean, default: true, description: Whether JR timestamping is supported. }
      required: [name, direction]

    MidiEndpoint:
      allOf:
        - $ref: '#/components/schemas/MidiEndpointCreate'
        - type: object
          properties:
            id: { type: string, format: uuid, description: Endpoint identifier. }

    UMPWord:
      type: integer
      format: uint32
      minimum: 0
      maximum: 4294967295
      description: 32-bit word of a Universal MIDI Packet.

    UMPPacket:
      type: object
      description: Up to four 32-bit UMP words constituting a MIDI 2.0 packet.
      properties:
        w0: { $ref: '#/components/schemas/UMPWord' }
        w1: { $ref: '#/components/schemas/UMPWord' }
        w2: { $ref: '#/components/schemas/UMPWord' }
        w3: { $ref: '#/components/schemas/UMPWord' }
      required: [w0]

    MidiEvent:
      type: object
      description: Timestamped MIDI 2.0 event to be scheduled or reported by the runtime.
      properties:
        tNs: { $ref: '#/components/schemas/TimestampNs' }
        packet: { $ref: '#/components/schemas/UMPPacket' }
        sourceEndpointId: { type: string, format: uuid, nullable: true, description: Originating endpoint (if applicable). }
      required: [tNs, packet]

    MidiInBatch:
      type: object
      description: Batch of MIDI events to inject into the runtime for tests.
      properties:
        timeDomain:
          type: string
          enum: [absoluteNs, relativeToNow]
          default: absoluteNs
          description: Interpretation of event timestamps (absolute ns or relative deltas).
        events:
          type: array
          items: { $ref: '#/components/schemas/MidiEvent' }
          description: Events to inject.
      required: [events]

    MidiOutBatch:
      type: object
      description: Batch of MIDI events returned for inspection.
      properties:
        events:
          type: array
          items: { $ref: '#/components/schemas/MidiEvent' }
        nextSinceNs: { $ref: '#/components/schemas/TimestampNs' }

    # ---------------- Audio (headless tests)
    AudioRenderRequest:
      type: object
      description: Offline render request (no hardware I/O).
      properties:
        frames: { type: integer, minimum: 1, description: Number of frames to render. }
        atTimeNs:
          oneOf:
            - { $ref: '#/components/schemas/TimestampNs' }
            - { type: 'null' }
          description: Optional start time; defaults to current clock.
        format:
          type: string
          enum: [f32le, s16le]
          default: f32le
          description: Output PCM sample format.
        channels: { type: integer, enum: [1, 2], default: 2, description: Number of output channels. }
      required: [frames]

    AudioRenderResponse:
      type: object
      description: Offline render result containing the PCM and metadata.
      properties:
        startNs: { $ref: '#/components/schemas/TimestampNs' }
        endNs: { $ref: '#/components/schemas/TimestampNs' }
        frames: { type: integer, description: Number of frames rendered. }
        pcmBase64: { type: string, format: byte, description: Base64-encoded interleaved PCM payload. }
        eventsConsumed: { type: integer, description: Number of MIDI events consumed in this render window. }

    # ---------------- Faults, Tests, Metrics, Tracing
    FaultModel:
      type: object
      description: Configurable fault injection model for stressing the runtime.
      properties:
        midi:
          type: object
          properties:
            jitterNsP50: { $ref: '#/components/schemas/DurationNs' }
            jitterNsP99: { $ref: '#/components/schemas/DurationNs' }
            dropRate: { type: number, minimum: 0, maximum: 1, default: 0, description: Probability of dropping an event. }
            duplicateRate: { type: number, minimum: 0, maximum: 1, default: 0, description: Probability of duplicating an event. }
        audio:
          type: object
          properties:
            callbackStallNsP99: { $ref: '#/components/schemas/DurationNs' }
            overrunEveryNBlocks: { type: integer, minimum: 0, description: Inject an overlong callback every N blocks (0 disables). }
        clock:
          type: object
          properties:
            driftPpm: { type: number, default: 0, description: Simulated clock drift in parts per million. }
            resyncEveryNs: { $ref: '#/components/schemas/DurationNs' }
      additionalProperties: false

    TestScenario:
      type: object
      description: Script describing a deterministic test run.
      properties:
        name: { type: string }
        seed: { type: integer, description: Optional RNG seed for fuzz steps. }
        midi:
          type: array
          description: Scripted UMP injections (absolute tNs recommended).
          items: { $ref: '#/components/schemas/MidiEvent' }
        steps:
          type: array
          description: Sequence of time advances and optional render/video actions.
          items:
            type: object
            properties:
              advanceNs: { $ref: '#/components/schemas/DurationNs' }
              renderFrames: { type: integer, description: If present, perform an offline render of this size after advancing time. }
              videoTick: { type: boolean, description: If true, emit a simulated video tick after advancing time. }
        asserts:
          type: array
          description: Optional assertions to validate at scenario completion.
          items: { $ref: '#/components/schemas/Assertion' }

    Assertion:
      type: object
      description: Declarative test assertion for post-run validation.
      properties:
        kind:
          type: string
          enum: [noDrops, maxLatencyNs, orderNonDecreasing, queueDepthLe, underrunsEq]
        value: { type: string, description: Numeric threshold or expected count (as string). }
        target:
          type: string
          enum: [midi, audio]
          description: Subsystem the assertion applies to.

    Metrics:
      type: object
      description: Aggregated runtime metrics suitable for dashboards and CI gates.
      properties:
        clockNowNs: { $ref: '#/components/schemas/TimestampNs' }
        counters:
          type: object
          additionalProperties: { type: integer }
          description: Named counters (e.g., underruns, drops, lateEvents).
        queueDepths:
          type: object
          properties:
            midiToAudio: { type: integer }
            midiToVideo: { type: integer }
        latenciesNs:
          type: object
          properties:
            midiScheduleToConsume:
              type: object
              properties:
                p50: { $ref: '#/components/schemas/DurationNs' }
                p95: { $ref: '#/components/schemas/DurationNs' }
                p99: { $ref: '#/components/schemas/DurationNs' }

    ClockNow:
      type: object
      description: Current master clock value and mode.
      properties:
        nowNs: { $ref: '#/components/schemas/TimestampNs' }
        mode: { type: string, enum: [system, test], description: Clock mode; test mode advances only via API calls. }

    TraceEvent:
      type: object
      description: Union type for trace events emitted by the runtime.
      oneOf:
        - $ref: '#/components/schemas/TraceMidiIn'
        - $ref: '#/components/schemas/TraceMidiConsume'
        - $ref: '#/components/schemas/TraceAudioCb'
        - $ref: '#/components/schemas/TraceVideoTick'
        - $ref: '#/components/schemas/TraceFault'

    TraceMidiIn:
      type: object
      description: Trace for MIDI events ingested by the runtime.
      properties:
        type: { const: midi_in }
        tNs: { $ref: '#/components/schemas/TimestampNs' }
        event: { $ref: '#/components/schemas/MidiEvent' }

    TraceMidiConsume:
      type: object
      description: Trace for MIDI events consumed by the audio thread.
      properties:
        type: { const: midi_consume }
        tNs: { $ref: '#/components/schemas/TimestampNs' }
        count: { type: integer }

    TraceAudioCb:
      type: object
      description: Trace for an audio callback window, including duration and frame count.
      properties:
        type: { const: audio_cb }
        startNs: { $ref: '#/components/schemas/TimestampNs' }
        endNs: { $ref: '#/components/schemas/TimestampNs' }
        frames: { type: integer }
        durationNs: { $ref: '#/components/schemas/DurationNs' }

    TraceVideoTick:
      type: object
      description: Trace for a video tick event.
      properties:
        type: { const: video_tick }
        tNs: { $ref: '#/components/schemas/TimestampNs' }
        frameIndex: { type: integer }

    TraceFault:
      type: object
      description: Trace for a generated fault or warning.
      properties:
        type: { const: fault }
        tNs: { $ref: '#/components/schemas/TimestampNs' }
        detail: { type: string }

    # ---------------- Hardware audio adapter
    AudioBackendStatus:
      type: object
      description: Current backend binding, negotiated stream configuration, and health.
      properties:
        backend: { $ref: '#/components/schemas/AudioBackend' }
        state: { type: string, enum: [idle, bound, streaming], default: idle }
        boundDevice: { $ref: '#/components/schemas/AudioDeviceRef', nullable: true }
        negotiated: { $ref: '#/components/schemas/StreamConfig', nullable: true }
        canLowLatency: { type: boolean, description: True if backend supports low-latency configuration for the bound device. }
        lastError: { type: string, nullable: true, description: Last backend error message, if any. }

    AudioBackendPolicy:
      type: object
      description: Non-stream policy for backend behavior and (on iOS/tvOS) AVAudioSession.
      properties:
        preferredBackend: { $ref: '#/components/schemas/AudioBackend' }
        rebindPolicy: { $ref: '#/components/schemas/RebindPolicy' }
        iosSession: { $ref: '#/components/schemas/AVAudioSessionConfig' }
      additionalProperties: false

    RebindPolicy:
      type: object
      description: Behavior when routes or formats change.
      properties:
        onRouteChange:
          type: string
          enum: [auto_rebind, pause_stream, fail]
          default: auto_rebind
          description: Action to take when system audio route changes.
        onFormatChange:
          type: string
          enum: [auto_renegotiate, pause_stream, fail]
          default: auto_renegotiate
          description: Action to take when device format changes.
        preferDefaultDevice: { type: boolean, default: true, description: Rebind to system default device when present. }
      additionalProperties: false

    AudioDeviceRef:
      type: object
      description: Opaque reference to an audio device.
      properties:
        id: { type: string, description: Backend-specific identifier (e.g., CoreAudio AudioObjectID as string). }
        scope: { type: string, enum: [output, input, duplex], description: Device direction. }
        name: { type: string, description: Human-readable device name. }

    AudioDeviceInfo:
      allOf:
        - $ref: '#/components/schemas/AudioDeviceRef'
        - type: object
          description: Detailed information about an audio device's capabilities.
          properties:
            manufacturer: { type: string, nullable: true }
            isDefault: { type: boolean }
            sampleRatesHz:
              type: array
              items: { type: number }
              minItems: 1
              description: Supported sample rates.
            channelLayouts:
              type: array
              items: { type: string, enum: [mono, stereo] }
              description: Supported logical channel layouts for simple cases.
            defaultBlockFrames: { type: integer, nullable: true, description: Backend-suggested nominal block size. }
            latencyFrames:
              type: object
              properties:
                input: { type: integer, nullable: true }
                output: { type: integer, nullable: true }

    StreamNegotiation:
      type: object
      description: Desired stream configuration for device binding.
      properties:
        desired: { $ref: '#/components/schemas/StreamConfig' }
        allowFormatFallback: { type: boolean, default: true, description: Permit graceful fallback to nearest supported configuration. }
      required: [desired]

    StreamConfig:
      type: object
      description: Negotiated (or desired) hardware stream configuration.
      properties:
        sampleRate: { type: number, description: Sample rate in Hz. }
        blockFrames: { type: integer, description: Frames per hardware callback. }
        channels: { type: integer, enum: [1, 2], description: Number of interleaved channels. }
        format: { type: string, enum: [f32, s16], default: f32, description: Sample format for device I/O. }
        deviceTimebaseHz:
          type: number
          description: Hardware clock rate used for timestamp conversion (e.g., nominal sampleRate).
      required: [sampleRate, blockFrames, channels]

    IOStats:
      type: object
      description: Live hardware I/O statistics for performance monitoring.
      properties:
        callbacks: { type: integer, description: Total number of audio callbacks fired since stream start. }
        underruns: { type: integer, description: Number of output underrun incidents observed. }
        avgCallbackNs: { $ref: '#/components/schemas/DurationNs' }
        p99CallbackNs: { $ref: '#/components/schemas/DurationNs' }
        maxQueueDepthMidiToAudio: { type: integer, description: Observed maximum depth of the MIDI→Audio queue. }
        lastBlockStartNs: { $ref: '#/components/schemas/TimestampNs' }
        lastBlockEndNs: { $ref: '#/components/schemas/TimestampNs' }

    BackendEvent:
      type: object
      description: Union type of backend events emitted over the backend WebSocket.
      oneOf:
        - $ref: '#/components/schemas/EvtRouteChange'
        - $ref: '#/components/schemas/EvtFormatChanged'
        - $ref: '#/components/schemas/EvtDeviceLost'
        - $ref: '#/components/schemas/EvtWarning'

    EvtRouteChange:
      type: object
      description: System audio route changed (e.g., headphones plugged in, new default device).
      properties:
        type: { const: route_change }
        reason: { type: string, enum: [new_default, headphones, bluetooth, hdmi, unknown] }
        newDevice: { $ref: '#/components/schemas/AudioDeviceRef', nullable: true }
        timestampNs: { $ref: '#/components/schemas/TimestampNs' }

    EvtFormatChanged:
      type: object
      description: Device format renegotiated (sample rate, block size, or channels changed).
      properties:
        type: { const: format_changed }
        negotiated: { $ref: '#/components/schemas/StreamConfig' }
        timestampNs: { $ref: '#/components/schemas/TimestampNs' }

    EvtDeviceLost:
      type: object
      description: The active device was disconnected or became unavailable.
      properties:
        type: { const: device_lost }
        lastKnownDevice: { $ref: '#/components/schemas/AudioDeviceRef' }
        timestampNs: { $ref: '#/components/schemas/TimestampNs' }

    EvtWarning:
      type: object
      description: Non-fatal backend warning or advisory.
      properties:
        type: { const: warning }
        message: { type: string }
        timestampNs: { $ref: '#/components/schemas/TimestampNs' }