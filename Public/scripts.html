<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fountain Scripts Catalog</title>
  <style>
    body { font: 14px/1.5 -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial; margin: 2rem; }
    h1 { margin-bottom: .5rem }
    .note { color: #666; margin-bottom: 1rem }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: .5rem; text-align: left; }
    th { background: #f7f7f7 }
    code { background: #f5f5f5; padding: .1rem .3rem; border-radius: 3px }
  </style>
</head>
<body>
  <h1>Fountain Scripts Catalog</h1>
  <div class="note">
    This view fetches from Persist. Provide <code>?persist=</code> and <code>&corpus=</code> params if needed. Example:
    <code>/scripts.html?persist=http://127.0.0.1:8005&corpus=fountain-scripts</code>.
  </div>
  <div id="summary"></div>
  <table id="tbl"><thead><tr><th>Script</th><th>Version</th><th>Path</th><th>Usage (first line)</th></tr></thead><tbody></tbody></table>

  <script>
    (async function(){
      const qs = new URLSearchParams(location.search);
      const persist = qs.get('persist') || 'http://127.0.0.1:8005';
      const corpus = qs.get('corpus') || 'fountain-scripts';
      const $ = sel => document.querySelector(sel);
      try {
        const pages = await fetch(`/api/scripts/pages?limit=500&sort=title&corpus=${encodeURIComponent(corpus)}`).then(r=>r.json());
        const list = pages.pages || [];
        $('#summary').textContent = `Corpus ${corpus} â€” ${list.length} scripts`;
        const tbody = $('#tbl tbody');
        for (const p of list){
          const pid = p.pageId;
          const name = p.title;
          const ver = (pid.split('@')[1]||'').slice(0,12);
          // query usage segment via text search on pageId
          const segs = await fetch(`/api/scripts/segments?limit=200&corpus=${encodeURIComponent(corpus)}&q=${encodeURIComponent(pid)}`).then(r=>r.json());
          const usage = (segs.segments||[]).find(s=>s.kind==='usage');
          const usageFirst = usage ? (usage.text||'').split('\n')[0] : '';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${name}</td><td><code>${ver}</code></td><td><code>${p.url}</code></td><td>${usageFirst}</td>`;
          tbody.appendChild(tr);
        }
      } catch (e) {
        $('#summary').textContent = 'Failed to load scripts. Ensure Persist allows CORS or open from the same origin.';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
