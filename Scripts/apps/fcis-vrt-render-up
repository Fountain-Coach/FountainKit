#!/usr/bin/env bash
set -euo pipefail

usage(){ cat <<USAGE >&2
FCIS-VRT Render Up â€” start pbvrt-server (legacy) on a free port, write stamp, and wait for readiness.

Usage:
  $(basename "$0") [--port 8010] [--corpus pb-vrt] [--store <dir>] [--timeout 25]

Writes chosen port to .fountain/pb-vrt-port and logs to .fountain/logs/pbvrt-server.log
USAGE
}

PORT=8010
CORPUS="pb-vrt"
STORE=""
TIMEOUT=45
PREBUILD=1
while [[ $# -gt 0 ]]; do
  case "$1" in
    --port) PORT="$2"; shift 2;;
    --corpus) CORPUS="$2"; shift 2;;
    --store) STORE="$2"; shift 2;;
    --timeout) TIMEOUT="$2"; shift 2;;
    --no-prebuild) PREBUILD=0; shift 1;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2;;
  esac
done

mkdir -p .fountain/logs .fountain

pick_port(){
  local p=$1
  for i in {0..10}; do
    if ! lsof -nP -iTCP:"$p" -sTCP:LISTEN >/dev/null 2>&1; then
      echo "$p"; return 0
    fi
    p=$((p+1))
  done
  return 1
}

# Prefer killing any stale pbvrt-server on desired range
for pid in $(pgrep -f "pbvrt-server" || true); do
  kill "$pid" 2>/dev/null || true
done

PORT=$(pick_port "$PORT") || { echo "No free port in range." >&2; exit 1; }
echo "Starting pbvrt-server (legacy) on port $PORT (corpus=$CORPUS)" >&2

if [[ "$PREBUILD" == "1" ]]; then
  echo "Prebuilding pbvrt-server (legacy, speeds up first launch)..." >&2
  FOUNTAIN_SKIP_LAUNCHER_SIG=1 swift build --package-path Packages/FountainApps -c debug --target pbvrt-server >/dev/null 2>&1 || true
fi

ENVVARS=("FOUNTAIN_SKIP_LAUNCHER_SIG=1" "PBVRT_CORPUS_ID=$CORPUS" "PBVRT_PORT=$PORT")
if [[ -n "$STORE" ]]; then ENVVARS+=("FOUNTAINSTORE_DIR=$STORE"); fi

(
  export ${ENVVARS[@]}
  nohup swift run --package-path Packages/FountainApps pbvrt-server \
    > .fountain/logs/pbvrt-server.log 2>&1 & echo $! > .fountain/pb-vrt-pid
) 

echo "$PORT" > .fountain/pb-vrt-port

# Wait for readiness
URL="http://127.0.0.1:${PORT}/pb-vrt/openapi.yaml"
for ((i=0;i<TIMEOUT;i++)); do
  if curl -fsS "$URL" >/dev/null 2>&1; then
    echo "Ready at http://127.0.0.1:${PORT}/pb-vrt (legacy path)" >&2
    exit 0
  fi
  sleep 1
done

echo "pbvrt-server did not become ready within ${TIMEOUT}s. Logs: .fountain/logs/pbvrt-server.log" >&2
echo "--- tail logs ---" >&2
tail -n 60 .fountain/logs/pbvrt-server.log >&2 || true
exit 1
