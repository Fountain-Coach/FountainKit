#!/usr/bin/env bash
set -euo pipefail

# Infinity — SDLKit infinite canvas launcher.
# Usage:
#   Scripts/apps/infinity          # start immediately (expects prebuilt binary)
#   Scripts/apps/infinity --build  # one-time build of infinity target

ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")"/../.. && pwd)
BUILD=0
for a in "$@"; do
  [[ "$a" == "--build" ]] && BUILD=1
done

export FK_USE_SDLKIT=${FK_USE_SDLKIT:-1}
export FOUNTAIN_SKIP_LAUNCHER_SIG=${FOUNTAIN_SKIP_LAUNCHER_SIG:-1}

APP_PKG="$ROOT_DIR/Packages/FountainApps"
BIN_DIR="$APP_PKG/.build/debug"
BIN="$BIN_DIR/infinity"

if (( BUILD )); then
  echo "[infinity] Building infinity once (debug)…"
  swift build --package-path "$APP_PKG" -c debug --target infinity
fi

if [[ ! -x "$BIN" ]]; then
  echo "[infinity] error: infinity binary not found at $BIN" >&2
  echo "[infinity] run with --build once to compile, then launch again without flags." >&2
  exit 1
fi

exec "$BIN"
