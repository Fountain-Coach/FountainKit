#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PORT="${1:-7777}"

if ! curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null 2>&1; then
  echo "[list-audio-devices] sidecar not healthy at http://127.0.0.1:${PORT} â€” starting it..." >&2
  "${ROOT}/Scripts/apps/run-sidecar.sh" >/dev/null 2>&1 &
  for i in {1..60}; do
    if curl -fsS "http://127.0.0.1:${PORT}/health" >/dev/null 2>&1; then break; fi
    sleep 0.25
  done
fi

echo "[list-audio-devices] GET /v1/audio/devices?scope=output"
curl -fsS "http://127.0.0.1:${PORT}/v1/audio/devices?scope=output" || true
echo
