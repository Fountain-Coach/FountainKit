#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
quietframe-stack â€” start/stop QuietFrame (instrument) + Sidecar

Usage:
  quietframe-stack up [--release]    Start sidecar and sonify (instrument)
  quietframe-stack down               Stop all processes
  quietframe-stack status             Show process status and ports

Notes:
  - Logs:   .fountain/logs/{sidecar,quietframe-sonify}.log
  - PIDs:   .fountain/pids/{sidecar,quietframe-sonify}.pid
  - Health: http://127.0.0.1:7777/health
EOF
}

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
LOGDIR="$ROOT/.fountain/logs"
PIDDIR="$ROOT/.fountain/pids"
CACHE="$ROOT/.fountain/clang-module-cache"
mkdir -p "$LOGDIR" "$PIDDIR" "$CACHE"

is_running() { local f="$1"; [[ -f "$f" ]] && kill -0 "$(cat "$f" 2>/dev/null)" 2>/dev/null; }
kill_pidfile() { local f="$1"; if [[ -f "$f" ]]; then kill "$(cat "$f" 2>/dev/null)" 2>/dev/null || true; rm -f "$f"; fi }

swift_build() {
  local target="$1"; local cfg="$2"
  CLANG_MODULE_CACHE_PATH="$CACHE" SWIFTPM_ENABLE_SANDBOX=0 swift build --package-path "$ROOT/Packages/FountainApps" -c "$cfg" --target "$target"
}

swift_bin_path() {
  local cfg="$1"
  CLANG_MODULE_CACHE_PATH="$CACHE" SWIFTPM_ENABLE_SANDBOX=0 swift build --package-path "$ROOT/Packages/FountainApps" -c "$cfg" --show-bin-path
}

start_proc() {
  local name="$1"; shift
  local pidf="$PIDDIR/$name.pid"
  local logf="$LOGDIR/$name.log"
  local cmd=("$@")
  if is_running "$pidf"; then echo "[$name] already running (pid $(cat "$pidf"))"; return 0; fi
  echo "[$name] starting... (logs: $logf)"
  ( nohup "${cmd[@]}" >"$logf" 2>&1 & echo $! >"$pidf" ) || { echo "[$name] failed"; return 1; }
  sleep 0.2
}

wait_health() {
  local url="http://127.0.0.1:7777/health"; local t=0; local max=60
  until curl -fsS "$url" >/dev/null 2>&1; do
    sleep 0.5; t=$((t+1)); if [[ $t -ge $max ]]; then echo "[sidecar] health timeout"; return 1; fi
  done
  echo "[sidecar] healthy at $url"
}

cmd_up() {
  local cfg="debug"; local coremidi="0"; local with_bridge="0"; local bridge_dest=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --release) cfg="release" ;;
      --coremidi) coremidi="1" ;;
      --with-bridge) with_bridge="1" ;;
      --dest) bridge_dest="$2"; shift ;;
      *) ;; 
    esac
    shift || true
  done
  # Build sidecar and run binary
  start_proc sidecar "$ROOT/Scripts/apps/run-sidecar.sh" "$cfg"
  wait_health || true
  # (Temporarily skip seeding here to avoid overlapping SwiftPM work; seed via app on demand.)
  # Launch QuietFrame app (skip rebuild)
  if [[ "$coremidi" == "1" ]]; then
    start_proc quietframe-sonify env QF_USE_RUNTIME=0 SKIP_BUILD=1 "$ROOT/Scripts/apps/run-quietframe-sonify.sh" "$cfg"
  else
    start_proc quietframe-sonify env SKIP_BUILD=1 "$ROOT/Scripts/apps/run-quietframe-sonify.sh" "$cfg"
  fi
  # Optionally start the MIDI bridge automatically
  if [[ "$with_bridge" == "1" ]]; then
    if [[ -n "$bridge_dest" ]]; then
      "$ROOT/Scripts/apps/quietframe-bridge" up --source "QuietFrame" --dest "$bridge_dest" || true
    else
      "$ROOT/Scripts/apps/quietframe-bridge" up --source "QuietFrame" || true
    fi
  fi
  echo "All started. Use: $0 status"
}

cmd_down() {
  kill_pidfile "$PIDDIR/quietframe-companion.pid"
  kill_pidfile "$PIDDIR/quietframe-sonify.pid"
  # Stop bridge if running
  if [[ -f "$PIDDIR/quietframe-bridge.pid" ]]; then "$ROOT/Scripts/apps/quietframe-bridge" down || true; fi
  kill_pidfile "$PIDDIR/sidecar.pid"
  echo "All stopped."
}

cmd_status() {
  for n in sidecar quietframe-sonify; do
    local pidf="$PIDDIR/$n.pid"; if is_running "$pidf"; then echo "[$n] pid $(cat "$pidf") running"; else echo "[$n] stopped"; fi
  done
}

case "${1-}" in
  up) shift; cmd_up "${1-}" ;;
  down) cmd_down ;;
  status) cmd_status ;;
  -h|--help|help|*) usage ;;
esac
