#!/usr/bin/env bash
set -euo pipefail

# Minimal gateway-only build helper
# Usage: Scripts/dev/gateway-min [build|run]

ROOT_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
PKG_PATH="$ROOT_DIR/Packages/FountainApps"

export FK_MIN_TARGET=gateway
# Do not enable editor-minimal gating here; it hides gateway-server.
export FOUNTAIN_SKIP_LAUNCHER_SIG=1

cmd="${1:-build}"
case "$cmd" in
  build)
    # Keep facts in sync with curated OpenAPI before building
    bash "$ROOT_DIR/Scripts/openapi/openapi-to-facts.sh" || true
    echo "[gateway-min] Building gateway-server (minimal)…"
    swift build --package-path "$PKG_PATH" -c debug --target gateway-server
    ;;
  run)
    # Keep facts in sync with curated OpenAPI before running
    bash "$ROOT_DIR/Scripts/openapi/openapi-to-facts.sh" || true
    echo "[gateway-min] Running gateway-server (minimal)…"
    swift run --package-path "$PKG_PATH" -c debug gateway-server
    ;;
  *)
    echo "Usage: $0 [build|run]" >&2
    exit 2
    ;;
esac
