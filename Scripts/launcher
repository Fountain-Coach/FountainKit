#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<USAGE
Usage: $(basename "$0") <start|stop|precompile> [--no-build|--force-build]
USAGE
}

if [[ $# -lt 1 ]]; then
  usage >&2
  exit 2
fi

COMMAND=$1
shift || true

REPO_ROOT=$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)
LOG_DIR="$REPO_ROOT/.fountain/logs"
mkdir -p "$LOG_DIR"

case "$COMMAND" in
  start)
    echo "[launcher] Starting Fountain services from $REPO_ROOT" | tee "$LOG_DIR/launcher.log"
    if [[ $# -gt 0 ]]; then
      echo "[launcher] Options: $*" | tee -a "$LOG_DIR/launcher.log"
    fi
    # Start LocalAgent under launcher control via manager unless disabled
    if [[ "${LAUNCHER_DISABLE_LOCAL_AGENT:-0}" != "1" ]]; then
      swift run --package-path "$REPO_ROOT/Packages/FountainApps" local-agent-manager ensure --repo-root "$REPO_ROOT" >>"$LOG_DIR/launcher.log" 2>&1 || true
      swift run --package-path "$REPO_ROOT/Packages/FountainApps" local-agent-manager start --repo-root "$REPO_ROOT" >>"$LOG_DIR/launcher.log" 2>&1 || true
    else
      echo "[launcher] Skipping LocalAgent (LAUNCHER_DISABLE_LOCAL_AGENT=1)" | tee -a "$LOG_DIR/launcher.log"
    fi
    ;;
  stop)
    echo "[launcher] Stopping Fountain services" | tee "$LOG_DIR/launcher.log"
    swift run --package-path "$REPO_ROOT/Packages/FountainApps" local-agent-manager stop --repo-root "$REPO_ROOT" >>"$LOG_DIR/launcher.log" 2>&1 || true
    ;;
  precompile)
    echo "[launcher] Precompiling Fountain services" | tee "$LOG_DIR/launcher.log"
    swift build --package-path "$REPO_ROOT/Packages/FountainApps" -c release >>"$LOG_DIR/launcher.log" 2>&1 || true
    swift run --package-path "$REPO_ROOT/Packages/FountainApps" -c release local-agent-manager precompile --repo-root "$REPO_ROOT" >>"$LOG_DIR/launcher.log" 2>&1 || true
    ;;
  *)
    usage >&2
    exit 2
    ;;
esac
