#!/usr/bin/env bash
set -euo pipefail

ROOT=$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)
COMPOSE_DIR="$ROOT/Configuration/tool-server"
COMPOSE_FILE=${TOOLSERVER_COMPOSE_FILE:-"$COMPOSE_DIR/docker-compose.yml"}
ENV_FILE_DEFAULT="$COMPOSE_DIR/.env"
WORKDIR=${TOOLSERVER_WORKDIR:-"$PWD"}
export TOOLSERVER_WORKDIR="$WORKDIR"

load_env() {
  local envfile="${TOOLSERVER_ENV_FILE:-$ENV_FILE_DEFAULT}"
  if [[ -f "$envfile" ]]; then
    # shellcheck disable=SC2046
    export $(grep -v '^#' "$envfile" | xargs -I{} echo {})
  fi
}

docker_compose() {
  load_env
  docker compose -f "$COMPOSE_FILE" "$@"
}

cmd=${1:-help}; shift || true

case "$cmd" in
  init|configure)
    mkdir -p "$COMPOSE_DIR"
    envfile="${TOOLSERVER_ENV_FILE:-$ENV_FILE_DEFAULT}"
    if [[ ! -f "$envfile" ]]; then
      cp "$COMPOSE_DIR/.env.example" "$envfile" 2>/dev/null || true
    fi
    : "${IMAGES_PULL_POLICY:=always}"
    : "${TOOLSERVER_WORKDIR:=$WORKDIR}"
    cat >"$envfile" <<EOF
# Generated by Scripts/toolserver
TOOLSERVER_WORKDIR=$TOOLSERVER_WORKDIR
IMAGES_PULL_POLICY=$IMAGES_PULL_POLICY
# IMAGEMAGICK_IMAGE=
# FFMPEG_IMAGE=
# EXIFTOOL_IMAGE=
# PANDOC_IMAGE=
# LIBPLIST_IMAGE=
EOF
    echo "Wrote $envfile"
    ;;
  pull)
    docker_compose pull "$@" ;;
  up)
    docker_compose up -d "$@" ;;
  down)
    docker_compose down ;;
  ps)
    docker_compose ps "$@" ;;
  logs)
    sub=${1:-compose}; shift || true
    case "$sub" in
      compose) docker_compose logs -f "$@" ;;
      tool-server) tail -f "$ROOT/.build/tool-server.log" ;;
      *) echo "usage: $0 logs <compose|tool-server>" ;;
    esac ;;
  run)
    svc=${1:-}; shift || true
    if [[ -z "$svc" ]]; then echo "usage: $0 run <service> [-- args...]"; exit 1; fi
    docker_compose run --rm -T "$svc" "$@" ;;
  status)
    curl -sf "${TOOLSERVER_URL:-http://127.0.0.1:${PORT:-8012}}/_status" | jq . || curl -sf "${TOOLSERVER_URL:-http://127.0.0.1:${PORT:-8012}}/_status" || true ;;
  *)
    cat <<USAGE
usage: $0 <command>

Commands:
  init|configure   Create/update .env with sensible defaults
  pull             docker compose pull (respects .env)
  up               docker compose up -d
  down             docker compose down
  ps               docker compose ps
  run <svc> [args] docker compose run --rm -T <svc> [args]
  status           Query tool-server /_status

ENV:
  TOOLSERVER_WORKDIR   Host path mounted as /work (default: CWD)
  TOOLSERVER_COMPOSE_FILE  Compose file (default: Configuration/tool-server/docker-compose.yml)
  TOOLSERVER_ENV_FILE  Env file (default: Configuration/tool-server/.env)
  TOOLSERVER_URL       Server URL for status (default: http://127.0.0.1:8012)
USAGE
    ;;
esac
